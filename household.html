<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household Settings - Mise Kitchen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="navbar-styles.css">
    <script src="navbar-loader.js"></script>
    <style>
        :root {
            --black: #0a0a0a;
            --dark-grey: #1a1a1a;
            --medium-grey: #404040;
            --light-grey: #e5e5e5;
            --white: #ffffff;
            --orange: #BEC5A4;
            --orange-hover: #A8AF8F;
            --orange-light: #F5F6F1;
            --green: #28a745;
            --green-light: #d4edda;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-grey);
            min-height: 100vh;
            color: var(--black);
            margin: 0;
            padding: 0;
            font-weight: 300;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            color: var(--black);
            margin-bottom: 20px;
            font-size: 2.5rem;
            font-weight: 400;
            letter-spacing: -0.02em;
        }

        .section {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }

        .section h2 {
            color: var(--black);
            font-size: 1.25rem;
            font-weight: 400;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light-grey);
        }

        .household-name {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .household-name input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--light-grey);
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .household-name input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(190, 197, 164, 0.15);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--orange);
            color: var(--white);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--light-grey);
        }

        .btn-secondary:hover {
            border-color: var(--orange);
            color: var(--orange);
        }

        .member-list, .invitation-list {
            list-style: none;
        }

        .member-item, .invitation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: var(--white);
            border: 1px solid var(--light-grey);
            border-radius: 8px;
        }

        .member-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .member-email {
            font-size: 15px;
            color: var(--black);
            font-weight: 300;
        }

        .member-role {
            font-size: 12px;
            color: var(--medium-grey);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-owner {
            background: var(--orange);
            color: var(--white);
        }

        .badge-member {
            background: var(--light-grey);
            color: var(--medium-grey);
        }

        .badge-pending {
            background: #ffc107;
            color: var(--black);
        }

        .invite-form {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .invite-form input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--light-grey);
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .invite-form input:focus {
            outline: none;
            border-color: var(--orange);
            box-shadow: 0 0 0 3px rgba(190, 197, 164, 0.15);
        }

        .empty-state {
            color: var(--medium-grey);
            font-style: italic;
            text-align: center;
            padding: 24px;
            font-size: 14px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .message-success {
            background: var(--green-light);
            border: 1px solid var(--green);
            color: #155724;
        }

        .message-error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
        }

        .message-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }

        .invite-link-box {
            background: var(--white);
            border: 2px solid var(--orange);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .invite-link-title {
            font-weight: 400;
            color: var(--black);
            margin-bottom: 12px;
            font-size: 14px;
        }

        .invite-link-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .invite-link-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--light-grey);
            border: 1px solid var(--medium-grey);
            border-radius: 6px;
            font-size: 13px;
            font-family: monospace;
            color: var(--black);
        }

        .copy-btn {
            padding: 10px 20px;
            background: var(--orange);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--orange-hover);
        }

        .copy-btn.copied {
            background: var(--green);
        }

        .invite-link-help {
            font-size: 12px;
            color: var(--medium-grey);
            font-style: italic;
        }

        .pending-invitations-section {
            background: var(--orange-light);
            border-color: var(--orange);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: #dc3545;
            color: var(--white);
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: var(--green);
            color: var(--white);
        }

        .btn-success:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            body {
                padding: 24px 16px;
            }

            h1 {
                font-size: 2rem;
            }

            .section {
                padding: 20px;
            }

            .invite-form {
                flex-direction: column;
            }

            .member-item, .invitation-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .action-buttons {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div id="navbar-placeholder"></div>

    <div class="container">
        <h1>Household Settings</h1>

        <div id="messages"></div>
        <div id="invite-link-section" style="display: none;"></div>

        <!-- Household Name Section -->
        <div class="section">
            <h2>Household Name</h2>
            <div class="household-name">
                <input type="text" id="household-name-input" placeholder="My Household" disabled>
                <button class="btn btn-primary" id="save-household-btn" onclick="window.updateHouseholdName()" disabled>Save</button>
            </div>
            <div id="household-loading" style="color: var(--medium-grey); font-size: 14px; margin-top: 8px; display: none;">
                Loading household data...
            </div>
        </div>

        <!-- Pending Invitations (for receiving invites) -->
        <div class="section pending-invitations-section" id="received-invitations-section" style="display: none;">
            <h2>ðŸ“¬ You've Been Invited!</h2>
            <p style="color: var(--medium-grey); font-size: 14px; margin-bottom: 16px;">
                Someone wants to share their kitchen with you. Accepting will move you to their household and you'll share all inventory, shopping lists, and recipes.
            </p>
            <ul class="invitation-list" id="received-invitations-list"></ul>
        </div>

        <!-- Current Members Section -->
        <div class="section">
            <h2>Current Members</h2>
            <ul class="member-list" id="members-list"></ul>
        </div>

        <!-- Invite Member Section -->
        <div class="section">
            <h2>Invite Member</h2>
            <p style="color: var(--medium-grey); font-size: 14px; margin-bottom: 16px;">
                Enter their email address and we'll create a shareable link you can text or email to them.
            </p>
            <div class="invite-form">
                <input type="email" id="invite-email-input" placeholder="email@example.com">
                <button class="btn btn-primary" onclick="window.sendInvitation()">Create Invite Link</button>
            </div>
        </div>

        <!-- Sent Invitations Section -->
        <div class="section">
            <h2>Pending Invitations</h2>
            <p style="color: var(--medium-grey); font-size: 14px; margin-bottom: 16px;">
                People you've invited who haven't joined yet. You can cancel an invitation at any time.
            </p>
            <ul class="invitation-list" id="sent-invitations-list"></ul>
            <div id="sent-empty" class="empty-state">No pending invitations</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, onSnapshot, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDARcrvn9kx6F47f4Uc2Ypd2ikQRANwX7A",
            authDomain: "kitchen-app-48dfd.firebaseapp.com",
            projectId: "kitchen-app-48dfd",
            storageBucket: "kitchen-app-48dfd.firebasestorage.app",
            messagingSenderId: "1085782615169",
            appId: "1:1085782615169:web:c13f6604456b9f221c9980",
            measurementId: "G-5QM7PRV02K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let householdId = null;
        let householdData = null;

        // Check authentication and load data
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;

            // Display user email in dropdown (wait for navbar to load)
            const updateEmail = () => {
                const emailElement = document.getElementById('user-email');
                if (emailElement) {
                    emailElement.textContent = user.email;
                } else {
                    // Navbar not loaded yet, try again in a moment
                    setTimeout(updateEmail, 100);
                }
            };
            updateEmail();

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));

                console.log('User document exists:', userDoc.exists());
                console.log('User data:', userDoc.data());

                if (userDoc.exists()) {
                    householdId = userDoc.data().householdId;
                    console.log('Household ID:', householdId);

                    await loadHouseholdData();
                    await loadMembers();
                    await loadSentInvitations();
                    await loadReceivedInvitations();
                } else {
                    // User document doesn't exist - create it now
                    console.log('User document not found, creating account setup...');
                    showMessage('Setting up your account for the first time...', 'info');

                    // Create household first
                    householdId = 'household_' + user.uid;
                    const newHouseholdData = {
                        name: 'My Household',
                        createdAt: new Date().toISOString(),
                        createdBy: user.uid,
                        members: [user.uid]
                    };

                    await setDoc(doc(db, 'households', householdId), newHouseholdData);
                    console.log('Household created:', householdId);

                    // Create user document
                    await setDoc(doc(db, 'users', user.uid), {
                        email: user.email,
                        householdId: householdId,
                        createdAt: new Date().toISOString()
                    });
                    console.log('User document created');

                    showMessage('Account setup complete! Reloading...', 'success');

                    // Reload the page to start fresh
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showMessage('Error loading user data: ' + error.message, 'error');
            }
        });

        // Load household data
        async function loadHouseholdData() {
            try {
                document.getElementById('household-loading').style.display = 'block';

                const householdDoc = await getDoc(doc(db, 'households', householdId));
                if (householdDoc.exists()) {
                    householdData = householdDoc.data();
                    document.getElementById('household-name-input').value = householdData.name || 'My Household';
                } else {
                    // Household doesn't exist - create it
                    householdData = {
                        name: 'My Household',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.uid,
                        members: [currentUser.uid]
                    };
                    await setDoc(doc(db, 'households', householdId), householdData);
                    document.getElementById('household-name-input').value = 'My Household';
                }

                // Enable the input and button
                document.getElementById('household-name-input').disabled = false;
                document.getElementById('save-household-btn').disabled = false;
                document.getElementById('household-loading').style.display = 'none';

                // Add Enter key support
                document.getElementById('household-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        updateHouseholdName();
                    }
                });
            } catch (error) {
                console.error('Error loading household:', error);
                showMessage('Error loading household data: ' + error.message, 'error');
                document.getElementById('household-loading').textContent = 'Error loading household data';
            }
        }

        // Update household name
        async function updateHouseholdName() {
            const newName = document.getElementById('household-name-input').value.trim();

            if (!newName) {
                showMessage('Please enter a household name', 'error');
                return;
            }

            if (!householdId) {
                showMessage('Loading household data, please try again in a moment', 'error');
                return;
            }

            try {
                await updateDoc(doc(db, 'households', householdId), {
                    name: newName
                });
                householdData.name = newName; // Update local data
                showMessage('Household name updated successfully!', 'success');
            } catch (error) {
                showMessage('Error updating household name: ' + error.message, 'error');
            }
        }
        window.updateHouseholdName = updateHouseholdName;

        // Load household members
        async function loadMembers() {
            const membersList = document.getElementById('members-list');
            membersList.innerHTML = '';

            if (!householdData || !householdData.members) {
                membersList.innerHTML = '<div class="empty-state">No members</div>';
                return;
            }

            for (const memberId of householdData.members) {
                const userDoc = await getDoc(doc(db, 'users', memberId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const isOwner = memberId === householdData.createdBy;
                    const isCurrentUser = memberId === currentUser.uid;

                    const li = document.createElement('li');
                    li.className = 'member-item';
                    li.innerHTML = `
                        <div class="member-info">
                            <span class="member-email">${userData.email}${isCurrentUser ? ' (You)' : ''}</span>
                            <span class="member-role">${isOwner ? 'Owner' : 'Member'}</span>
                        </div>
                        <span class="badge ${isOwner ? 'badge-owner' : 'badge-member'}">
                            ${isOwner ? 'Owner' : 'Member'}
                        </span>
                    `;
                    membersList.appendChild(li);
                }
            }
        }

        // Send invitation
        async function sendInvitation() {
            const email = document.getElementById('invite-email-input').value.trim().toLowerCase();

            if (!email) {
                showMessage('Please enter an email address', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('Please enter a valid email address', 'error');
                return;
            }

            if (email === currentUser.email.toLowerCase()) {
                showMessage('You cannot invite yourself', 'error');
                return;
            }

            if (!householdId || !householdData) {
                showMessage('Loading household data, please try again in a moment', 'error');
                return;
            }

            try {
                // Find user by email (if they exist)
                const usersQuery = query(collection(db, 'users'), where('email', '==', email));
                const usersSnapshot = await getDocs(usersQuery);

                let inviteeId = null;

                if (!usersSnapshot.empty) {
                    // User exists - check if they're already in this household
                    const inviteeDoc = usersSnapshot.docs[0];
                    inviteeId = inviteeDoc.id;
                    const inviteeData = inviteeDoc.data();

                    if (inviteeData.householdId === householdId) {
                        showMessage('This user is already in your household', 'error');
                        return;
                    }
                }

                // Check if invitation already exists (by email)
                const invitationsQuery = query(
                    collection(db, 'invitations'),
                    where('householdId', '==', householdId),
                    where('inviteeEmail', '==', email),
                    where('status', '==', 'pending')
                );
                const existingInvitations = await getDocs(invitationsQuery);

                if (!existingInvitations.empty) {
                    showMessage('An invitation has already been sent to this email address', 'error');
                    return;
                }

                // Create invitation (works for both existing and non-existing users)
                const invitationRef = doc(collection(db, 'invitations'));
                await setDoc(invitationRef, {
                    householdId: householdId,
                    householdName: householdData.name || 'My Household',
                    inviterId: currentUser.uid,
                    inviterEmail: currentUser.email,
                    inviteeId: inviteeId, // Will be null if user doesn't exist yet
                    inviteeEmail: email,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                });

                // Create shareable link
                const inviteLink = window.location.origin + window.location.pathname.replace('household.html', 'accept-invite.html') + '?id=' + invitationRef.id;

                showInviteLink(email, inviteLink);

                document.getElementById('invite-email-input').value = '';
                await loadSentInvitations();
            } catch (error) {
                showMessage('Error sending invitation: ' + error.message, 'error');
            }
        }
        window.sendInvitation = sendInvitation;

        // Load sent invitations
        async function loadSentInvitations() {
            const sentList = document.getElementById('sent-invitations-list');
            const emptyState = document.getElementById('sent-empty');

            const invitationsQuery = query(
                collection(db, 'invitations'),
                where('householdId', '==', householdId),
                where('status', '==', 'pending')
            );

            onSnapshot(invitationsQuery, (snapshot) => {
                sentList.innerHTML = '';

                if (snapshot.empty) {
                    sentList.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    sentList.style.display = 'block';
                    emptyState.style.display = 'none';

                    snapshot.forEach((docSnap) => {
                        const invitation = docSnap.data();
                        const inviteLink = window.location.origin + window.location.pathname.replace('household.html', 'accept-invite.html') + '?id=' + docSnap.id;

                        const li = document.createElement('li');
                        li.className = 'invitation-item';
                        li.innerHTML = `
                            <div class="member-info">
                                <span class="member-email">${invitation.inviteeEmail}</span>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="window.copyPendingInviteLink('${inviteLink}', this)">Copy Link</button>
                                <button class="btn btn-danger btn-small" onclick="window.cancelInvitation('${docSnap.id}')">Cancel</button>
                            </div>
                        `;
                        sentList.appendChild(li);
                    });
                }
            });
        }

        // Copy pending invitation link
        window.copyPendingInviteLink = async function(link, buttonElement) {
            try {
                await navigator.clipboard.writeText(link);
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');

                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            } catch (error) {
                // Fallback for older browsers
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'Copied!';
                buttonElement.classList.add('copied');

                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }
        };

        // Cancel invitation
        async function cancelInvitation(invitationId) {
            try {
                await deleteDoc(doc(db, 'invitations', invitationId));
                showMessage('Invitation cancelled', 'success');
            } catch (error) {
                showMessage('Error cancelling invitation: ' + error.message, 'error');
            }
        }
        window.cancelInvitation = cancelInvitation;

        // Load received invitations
        async function loadReceivedInvitations() {
            const section = document.getElementById('received-invitations-section');
            const list = document.getElementById('received-invitations-list');

            // Query by user ID
            const invitationsQueryById = query(
                collection(db, 'invitations'),
                where('inviteeId', '==', currentUser.uid),
                where('status', '==', 'pending')
            );

            // Query by email (for invitations sent before account was created)
            const invitationsQueryByEmail = query(
                collection(db, 'invitations'),
                where('inviteeEmail', '==', currentUser.email.toLowerCase()),
                where('status', '==', 'pending')
            );

            // Combine both queries
            const [snapshotById, snapshotByEmail] = await Promise.all([
                getDocs(invitationsQueryById),
                getDocs(invitationsQueryByEmail)
            ]);

            // Merge results and remove duplicates
            const allInvitations = new Map();
            snapshotById.forEach(doc => allInvitations.set(doc.id, doc));
            snapshotByEmail.forEach(doc => {
                // Update inviteeId if it was null (invitation sent before account creation)
                if (!doc.data().inviteeId) {
                    updateDoc(doc.ref, { inviteeId: currentUser.uid });
                }
                allInvitations.set(doc.id, doc);
            });

            list.innerHTML = '';

            if (allInvitations.size === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';

                allInvitations.forEach((docSnap) => {
                    const invitation = docSnap.data();
                    const li = document.createElement('li');
                    li.className = 'invitation-item';
                    li.innerHTML = `
                        <div class="member-info">
                            <span class="member-email">${invitation.householdName}</span>
                            <span class="member-role">From ${invitation.inviterEmail}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-success btn-small" onclick="window.acceptInvitation('${docSnap.id}', '${invitation.householdId}')">Accept</button>
                            <button class="btn btn-danger btn-small" onclick="window.declineInvitation('${docSnap.id}')">Decline</button>
                        </div>
                    `;
                    list.appendChild(li);
                });
            }

            // Set up real-time listener for future invitations
            onSnapshot(invitationsQueryById, () => {
                loadReceivedInvitations();
            });
        }

        // Accept invitation
        async function acceptInvitation(invitationId, newHouseholdId) {
            if (!confirm('Are you sure? This will move you to the new household and you will leave your current household.')) {
                return;
            }

            try {
                // Remove user from current household
                await updateDoc(doc(db, 'households', householdId), {
                    members: arrayRemove(currentUser.uid)
                });

                // Add user to new household
                await updateDoc(doc(db, 'households', newHouseholdId), {
                    members: arrayUnion(currentUser.uid)
                });

                // Update user's household ID
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    householdId: newHouseholdId
                });

                // Delete the invitation (no need to keep it after acceptance)
                await deleteDoc(doc(db, 'invitations', invitationId));

                showMessage('Invitation accepted! Reloading...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } catch (error) {
                showMessage('Error accepting invitation: ' + error.message, 'error');
            }
        }
        window.acceptInvitation = acceptInvitation;

        // Decline invitation
        async function declineInvitation(invitationId) {
            try {
                await updateDoc(doc(db, 'invitations', invitationId), {
                    status: 'declined',
                    declinedAt: new Date().toISOString()
                });
                showMessage('Invitation declined', 'success');
            } catch (error) {
                showMessage('Error declining invitation: ' + error.message, 'error');
            }
        }
        window.declineInvitation = declineInvitation;

        // Show message
        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Show invitation link
        function showInviteLink(email, link) {
            const linkSection = document.getElementById('invite-link-section');
            linkSection.style.display = 'block';
            linkSection.innerHTML = `
                <div class="invite-link-box">
                    <div class="invite-link-title">âœ¨ Invite Link Ready!</div>
                    <div class="invite-link-container">
                        <input type="text" class="invite-link-input" value="${link}" readonly id="invite-link-input">
                        <button class="copy-btn" onclick="window.copyInviteLink()">Copy Link</button>
                    </div>
                    <div class="invite-link-help">
                        Copy this link and send it to ${email} via text, email, or any messaging app. When they click it, they can join your household instantly!
                    </div>
                </div>
            `;

            // Scroll to the link
            linkSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Copy invitation link to clipboard
        window.copyInviteLink = async function() {
            const input = document.getElementById('invite-link-input');
            const button = document.querySelector('.copy-btn');

            try {
                await navigator.clipboard.writeText(input.value);
                button.textContent = 'Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            } catch (error) {
                // Fallback for older browsers
                input.select();
                document.execCommand('copy');
                button.textContent = 'Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            }
        };

        // Logout function
        window.handleLogout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                alert('Error logging out: ' + error.message);
            }
        };
    </script>
</body>
</html>
